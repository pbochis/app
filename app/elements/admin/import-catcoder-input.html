<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">

<dom-module id="import-catcoder-input">
	<template>
		<iron-ajax
			id="postGame"
			method="POST"
			with-credentials="true"
			on-response="_onResponse"
			on-error="_onError">
		</iron-ajax>

		You must upload a zip file which contains the game structure
		<input id="input" type="file" accept="application/zip"><br>

		<paper-button id="uploadButton" on-click="_upload">Upload game</paper-button>
		<paper-toast id="toast">{{toastText}}</paper-toast>
	</template>
	<script>
		Polymer({
			is: 'import-catcoder-input',
			_upload: function(){
				if (this.$.input.files.length === 0){
					this.toastText = 'You must upload a zip file.';
					this.$.toast.show();
					return;
				}
				var file = this.$.input.files[0];
				var body = new FormData();
				body.append('file', file, file.name);
				body.append('organization', localStorage.activeOrganization);
				this.$.postGame.body = body;
				this.$.postGame.url = util.build('/contestgameupload');
				this.$.postGame.generateRequest();
				app.startLoading();
				this.$.uploadButton.disabled = true;
			},
			_onResponse: function(r){
				this.$.uploadButton.disabled = true;
				app.stopLoading();
				page('/challenges/template/' + r.detail.response);
			},
			_onError: function(e, req) {
				this.$.uploadButton.disabled = true;
				app.stopLoading();
				if (e.detail.request.xhr.status === 400) {
					this.toastText = req.request.xhr.response;
					this.$.toast.show();
					return;
				}
				util.error(e);
			}
		});
	</script>
</dom-module>