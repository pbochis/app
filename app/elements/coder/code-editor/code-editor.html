<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="file-explorer/explorer-item.html">
<link rel="import" href="file-explorer/context-menu.html">

<dom-module id="code-editor">
	<style include="iron-flex">
		:host {
			display: block;
			height: 100%;
		}
		#editor {
			height: calc(100% - 36px);
			z-index: 0;
		}
		.container {
			height: 100%;
			@apply(--layout-horizontal);
		}
		.editor-container {
			@apply(--layout-flex);
			height: 100%;
			@apply(--layout-vertical);
		}
		.explorer-container {
			width: 200px;
		}
	</style>
	<template>
		<context-menu id="contextMenu"></context-menu>
		<div class="container">
			<div class="explorer-container" style$="{{explorerStyle}}">
				<explorer-item id="rootFolder" node="{{tree.root}}" path=""></explorer-item>
			</div>
			<div class="editor-container">
				<div>
					<paper-icon-button icon="{{toggleExplorerIcon}}" on-click="_toggle"></paper-icon-button>
				</div>
				<div id="editor"></div>
			</div>
		</div>
	</template>
	<script src="../../../bower_components/ace-min-noconflict/ace.js" type="application/javascript"></script>
	<script src="../../../bower_components/ace-min-noconflict/theme-chrome.js" type="application/javascript"></script>
	<script src="../../../bower_components/ace-min-noconflict/ext-language_tools.js" type="application/javascript"></script>
	<script src="../../../scripts/tree.js" type="application/javascript"></script>

	<script>
		/*global ace:false */
		Polymer({
			is: 'code-editor',
			properties: {
				language: {
					type: String,
					reflectToAttribute: true,
					observer: '_languageChanged'
				},
				toggleExplorerIcon: {
					type: String,
					notify: true,
					value: 'chevron-left'
				},
				tree: {
					type: Object,
					notify: true,
					//TODO: When you create an empty tree(i.e. no template)  either make the code editor disabled when
					// there are no files, or by default create a file (think the first version is better, since it
					// can be reused to disable teh code editor whenever there are 0 files(all are deleted or some reason)
					value: function() {
						return new Tree({});
					},
					observer: '_treeChanged'
				},
				explorerStyle: {
					type: String,
					value: ''
				},
				selectedFile: {
					type: Object,
					notify: true,
					reflectToAttribute: true
				}
			},
			listeners: {
				'show-menu': '_showMenu',
				'file-selected': '_fileSelected',
				'rename': 'handleRename',
				'create': 'handleCreate'
			},
			ready: function() {
				this._addContextMenuListener();
				ace.require('ace/ext/language_tools');
				this.$.editor = ace.edit(this.$.editor);
				this.$.editor.setTheme('ace/theme/chrome');
				this.$.editor.setOptions({
					enableBasicAutocompletion: true
				});
				var that = this;
				this.$.editor.getSession().on('change', function() {
					var content = that.$.editor.getValue();
					that.selectedFile.setContent(content);
					console.log(that.tree.root);
				});
				this.$.editor.commands.addCommand({
					name: 'run',
					bindKey: {
						win: 'Ctrl-Enter'
					},
					exec: function() {
						that.fire('run-code');
					},
					readOnly: true
				});
				this.$.editor.$blockScrolling = Infinity;
			},
			_treeChanged: function(current, previous) {
				console.log('Tree changed from', (previous ? previous.root : undefined), 'to', current.root);
				this.$.rootFolder.set('node', current.root);
				//Polymer.dom(this.$.rootFolder).setAttribute('node', this.tree.root);
			},
			clearFiles: function() {
				this.tree = new Tree({});
				this.notifyPath('tree');
				if (!!this.selectedFile) {
					this.selectedFile.unselectFile();
					this.selectedFile = undefined;
				}
			},
			handleRename: function(e, detail) {
				if (detail.from === detail.to) {
					return;
				}

				if (this.tree.contains(detail.to)) {
					return;
				}

				var value = this.tree.get(detail.from);
				this.tree.remove(detail.from);
				this.tree.add(detail.to, value);
				this.tree = new Tree(JSON.parse(JSON.stringify(this.tree.root)));
				this.set('tree', this.tree);
			},
			handleCreate: function(e, detail) {
				if (this.tree.contains(detail.path)) {
					return;
				}
				this.tree.add(detail.path, '');
				console.log('Notifying for tree change after create.');
				this.tree = new Tree(JSON.parse(JSON.stringify(this.tree.root)))
				this.set('tree', this.tree);
			},
			handleAdd: function(e, detail) {
				if (this.tree.contains(detail.path)) {
					return;
				}
				this.tree.add(detail.path, detail.content);
				console.log('Notifying for tree change after add.');
				this.tree = new Tree(JSON.parse(JSON.stringify(this.tree.root)))
				this.set('tree', this.tree);
			},
			_fileSelected: function(e, detail) {
				if (!!this.selectedFile) {
					this.selectedFile.unselectFile();
				}
				this.selectedFile = detail;
				this.setValue(this.selectedFile.getContent());
			},
			_toggle: function() {
				if (this.toggleExplorerIcon === 'chevron-left') {
					this.explorerStyle = 'display: none';
					this.toggleExplorerIcon = 'chevron-right';
				} else {
					this.explorerStyle = '';
					this.toggleExplorerIcon = 'chevron-left';
				}
			},
			setFilesJson: function(rootFolder) {
				this.tree = new Tree(rootFolder);
				this.notifyPath('tree');
			},
			getFiles: function() {
				return this.tree.all().map(function(it) {
					var blob = new Blob([this.tree.get(it)]);
					blob.name = it;
					console.log(blob);
					return blob;
				}, this);
			},
			setValue: function(text) {
				if (text === null || text === undefined) {
					return;
				}
				if (!((typeof(text) === 'string' || text instanceof String))) {
					return;
				}
				this.$.editor.getSession().setValue(text);
			},
			addFile: function(f) {
				var fr = new FileReader();
				var that = this;
				fr.onload = function(e) {
					that.tree.add(f.name, e.target.result);
				};
				fr.readAsText(f);
			},
			_languageChanged: function() {
				if (this.language) {
					this._setMode(this.language);
				}
			},
			_setMode: function(lang) {
				var languageModeMap = {
					'c':      'c_cpp',
					'cpp':    'c_cpp',
					'csharp': 'csharp',
					'java':   'java',
					'js':     'javascript',
					'py':     'python',
					'go':     'golang',
					'scala':  'scala',
					'groovy': 'groovy',
					'php':    'php'
				};
				this.$.editor.getSession().setMode('ace/mode/' + (languageModeMap[lang] || 'text'));
			},
			_showMenu: function(event, data) {
				this.$.contextMenu.showMenu(data);
			},
			_addContextMenuListener: function() {
				var that = this;
				document.addEventListener('click', function(e) {
					if (that._clickInsideElement(e, 'context-menu')) {
						return;
					}
					if (that._clickInsideElement(e, 'explorer-folder')) {
						return;
					}
					var cm = document.querySelector('context-menu');
					if (cm) {
						cm.hideMenu();
					}
				});
			},
			_clickInsideElement: function(e, elName) {
				elName = elName.toLowerCase();
				var el = e.srcElement || e.target;
				if (el.tagName.toLowerCase() === elName) {
					return el;
				}

				while (!!(el = el.parentNode)) {
					if (!!el.tagName && el.tagName.toLowerCase() === elName) {
						return el;
					}
				}

				return false;
			}
		});
	</script>
</dom-module>
