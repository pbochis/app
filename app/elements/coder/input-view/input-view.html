<link rel="import" href="input-view-element.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-icons/av-icons.html">

<link rel="import" href="/elements/common/services/user-submission-service.html">

<dom-module id="input-view">
	<style>
		:host{
			display: block;
			height: 100%;
			width: 100%;
		}
	</style>
	<template>
		<iron-ajax
			id="getTestsRequest"
			handle-as="json"
			on-response="onTestsResponse"
			on-error="onTestsError"
			method="GET"
			with-credentials="true"
			>
		</iron-ajax>
		<user-submission-service id="userSubmissionService" on-error="_onError"></user-submission-service>
		<p>Paste/Upload the generated output and test it.</p>
		<template is="dom-repeat" items="{{testOutputs}}">
			<input-view-element id="{{_inputId(item.id)}}"
								test-id="{{item.id}}"
								input-value="{{item.inputValue}}"
								counter="{{item.counter}}">
			</input-view-element>
		</template>
			<paper-icon-button id="runButton" icon="av:play-arrow" on-click="runTests">Run tests</paper-icon-button>
	</template>
	<script>
	// TODO(victorbalan): move duplicate code(here and test-stats-console) to behavior
		Polymer({
			is: 'input-view',
			properties: {
				task: {
					type: Object,
					notify: true,
					reflectToAttribute: true
				},
				testOutputs: {
					type: Array,
					notify: true
				},
				testStats: {
					type: Object,
					value: {}
				}
			},
			observers: [
				'_afterPropertiesSet(task)'
			],
			listeners: {
				'green-test': 'onGreenTest'
			},
			_testAllGreen: function(){
				if(!this.tests){
					return;
				}
				for(var i = 0;i<this.tests.length; i ++){
					if(!this.testStats[this.tests[i].id]){
						return;
					}
				}
				this.fire('all-green');
			},
			runTests: function(){
				for (var i = 0; i < this.tests.length; i++){
					this.$$('#' + this._inputId(this.tests[i].id)).startLoading();
				}
				this.$.userSubmissionService.submitOutput(this.task.id, this.testOutputs);
			},
			setResult: function(result){
				if(!result.test){
					alert('this should not happen');
					return;
				}
				if(result.successful === undefined){
					result.successful = false;
				}
				this.testStats[result.test] = result.successful;
				this._testAllGreen();
				var testInput = this.$$('#' + this._inputId(result.test));
				testInput.setResult(result.successful);
			},
			_afterPropertiesSet: function(){
				this.testOutputs = [];
				this.$.getTestsRequest.url = util.build('/tasks/' + this.task.id + '/tests');
				this.$.getTestsRequest.generateRequest();
			},
			onTestsResponse: function(r){
				var data = r.detail.response;
				this.tests = data;
				for(var i=0;i<data.length;i++){
					this.push('testOutputs', {'id': data[i].id, 'counter': i + 1});
				}
			},
			onTestsError: function(err){
				util.error(err);
			},
			_inputId: function(testId){
				return 'test-' + testId;
			},
			_onError: function(event, e){
				util.error(e);
			}
		});
	</script>
</dom-module>
