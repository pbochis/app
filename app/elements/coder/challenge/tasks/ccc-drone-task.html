<link rel="import" href="/elements/coder/code-editor/consoles/run-submit-console.html">
<link rel="import" href="/elements/coder/code-editor/language-selector.html">
<link rel="import" href="/elements/coder/challenge/tasks/task-display.html">
<link rel="import" href="/elements/coder/code-editor/code-editor-with-actions.html">
<link rel="import" href="/elements/coder/input-view/input-view.html">
<link rel="import" href="/elements/common/leaderboard/challenge-leaderboard.html">
<link rel="import" href="/elements/common/services/result-service.html">

<link rel="import" href="/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="/bower_components/iron-icons/av-icons.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="ccc-drone-task">
<style include="iron-flex">
	:host{
		display: block;
		height: 100%;
		--paper-tabs-selection-bar-color: #87CEFA;
		--paper-tab-ink: #87CEFA;
	}
	.header{
		background: white;
		color: black;
		height: 50px;
		width: calc(100% - 24px);
		box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
	}
	.right {
		margin: 16px 16px 8px 8px;
		width: calc(100% - 24px);
	}
	.left {
		margin: 16px 8px 16px 16px;
		width: calc(100% - 24px);
	}
	#componentWrapper{
		height: 100%;
		@apply(--layout-horizontal);
	}
	#componentWrapper>div{
		height: 100%;
	}
	paper-material{
		width: 100%;
		margin: auto;
		background: white;
	}
	#leftCard{
		margin: 16px 8px 16px 16px;
		width: calc(100% - 24px);
		height: calc(100% - 98px);
	}
	#topRightCard{
		overflow: auto;
		margin: 16px 16px 16px 8px;
		width: calc(100% - 24px);
		height: calc(50% - 66px);
	}
	#botRightCard{
		overflow: hidden;
		margin: 8px 16px 16px 8px;
		width: calc(100% - 24px);
		height: calc(50% - 48px);
	}
	#buttons{
		height: 45px;
		margin: 16px 16px 16px 8px;
		@apply(--layout-horizontal);
	}
	#console{
		margin: 8px 16px 16px 16px;
		height: calc(100% - 85px);
	}
	#buttons>paper-icon-button{
		padding: 5px;
		margin: 0;
	}
	#buttons>language-selector{
		padding: 5px;
		margin: 0;
	}
	#inputViewRightCard {
		margin: 8px 16px 16px 8px;
		width: calc(100% - 24px);
		height: calc(100% - 98px);
	}
</style>
	<template>
		<result-service id="resultService" leaderboard="{{leaderboard}}"></result-service>

		<div id="componentWrapper">
			<div class="flex">
				<paper-tabs selected="{{leftTab}}" align-bottom="true" no-ink="true" class="header left">
					<paper-tab>Task description</paper-tab>
					<paper-tab>Leaderboard</paper-tab>
				</paper-tabs>

				<paper-material id="leftCard" elevation="1">
					<iron-pages selected="{{leftTab}}">
						<task-display task="{{task}}"></task-display>
						<challenge-leaderboard leaderboard="{{leaderboard}}"></challenge-leaderboard>
					</iron-pages>
				</paper-material>
			</div>
			<div class="flex">
				<paper-tabs selected="{{selected}}" align-bottom="true" no-ink="true" class="header right">
					<paper-tab>Input view</paper-tab>
					<paper-tab>Code editor view</paper-tab>
				</paper-tabs>
				<template is="dom-if" if="{{inputView}}">
					<paper-material id="inputViewRightCard" elevation="1">
						<input-view id="inputView" task="{{task}}"></input-view>
					</paper-material>
				</template>
				<template is="dom-if" if="{{!inputView}}">
					<paper-material id="topRightCard" elevation="1">
						<code-editor-with-actions id="codeEditor" task="{{task}}" language="{{language.value}}"></code-editor-with-actions>
					</paper-material>
					<paper-material id="botRightCard" elevation="1">
						<div id="buttons">
							<paper-icon-button class="self-center" icon="av:play-arrow" on-click="runCode">Run code</paper-icon-button>
							<language-selector class="self-center" id="languageSelector" task="{{task}}" language="{{language}}"></language-selector>
							<span class="flex"></span>
							<paper-button class="self-center" raised noink on-click="runTests">Run tests</paper-button>
						</div>
						<run-submit-console id="console" task="{{task}}" on-all-green="_allTestsGreen"></run-submit-console>
					</paper-material>
				</template>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'ccc-drone-task',
			properties: {
				task: {
					type: Object,
					notify: true,
					reflectToAttribute: true
				},
				challengeId: {
					type: Number,
					notify: true
				},
				selected: {
					type: Number,
					notify: true,
					observer: '_selectedChanged'
				},
				inputView: {
					type: Boolean,
					notify: true,
					value: false
				},
				leftTab: {
					type: Number,
					notify: true,
					value: 0,
					observer: '_selectedLeftTabChanged'
				},
				leaderboard: {
					type: Array,
					notify: true
				},
				intervalId: Number
			},
			observers: [
				'afterPropertiesSet(task, challengeId)'
			],
			listeners: {
				'ws-message': '_onMessage'
			},
			_selectedChanged: function(){
				switch(this.selected){
					case 0:
						this.inputView = true;
						return;
					case 1:
						this.inputView = false;
						return;
				}
			},
			_selectedLeftTabChanged: function(){
				switch (this.leftTab){
					case 0:
						clearInterval(this.intervalId);
						return;
					case 1:
						this._startPollingLeaderboard();
						return;
				}
			},
			_startPollingLeaderboard: function(){
				var that = this;
				this.intervalId = setInterval(function(){
					if (that.leftTab === 1){
						that.$.resultService.getLeaderboard(that.challengeId);
					}
				}, 5000);
			},
			_onMessage: function(m){
				this.$$('#console').setResult(JSON.parse(m.detail));
			},
			_allTestsGreen: function(){
				this.fire('level-completed');
			},
			afterPropertiesSet: function(){
				this.selected = 1;
				this.$.resultService.getLeaderboard(this.challengeId);
			},
			runCode: function(){
				this.$$('#codeEditor').run();
				this.$$('#console').runLoading();
			},
			runTests: function(){
				this.$$('#codeEditor').submit();
				this.$$('#console').submitLoading();
			},
			finishTask: function(){
				clearInterval(this.intervalId);
				this.fire('task-finished');
			}
		});
	</script>
</dom-module>
