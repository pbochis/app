<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">
<link rel="import" href="/elements/coder/challenge/page/challenge-display.html">
<link rel="import" href="/elements/coder/challenge/countdown-timer.html">
<link rel="import" href="/elements/coder/challenge/page/challenge-nav.html">
<link rel="import" href="/elements/common/services/task-service.html">

<dom-module id="sequential-challenge">
	<style>
		:host{
			display: block;
			height: 100%;
		}
		#content{
			height: calc(100% - 40px);
		}
		#startChallengeCard{
			width:35%;
		}
		#taskNavHeader{
			height: 40px;
			background: white;
			margin: 0;
			padding: 0;
		}
		#leftProgressFlex{
			margin-right: 50px;
		}
	</style>
	<template>
		<task-service id="taskService" task="{{task}}"></task-service>
		<challenge-nav id="coolNav" task-index="{{taskIndex}}" total-tasks="{{challenge.tasks.length}}"
			task-duration="{{task.duration}}" challenge-duration="{{challenge.duration}}"
			task-start-time="{{taskStartTime}}" challenge-start-time="{{challengeStartTime}}">
		</challenge-nav>

		<div id="content" style$="{{contentStyle}}">
		</div>
		<iron-ajax
			id="getResultRequest"
			handle-as="json"
			method="GET"
			with-credentials="true"
			>
		</iron-ajax>
	</template>
	<script>
		Polymer({
			// TODO(victorbalan): Refactor component and split logic and refactor requests. Remove duplicate code from ccc-challenge
			is: 'sequential-challenge',
			properties: {
				challenge: {
					type: Object,
					notify: true,
					reflectToAttribute: true
				},
				result: {
					type: Object,
					notify: true,
					reflectToAttribute: true
				},
				task: {
					type: Object,
					notify: true,
					observer: '_taskChanged'
				},
				taskIndex: {
					type: Number,
					notify: true,
					value: 0
				},
				contentStyle:{
					type: String,
					notify: true,
					value: 'display: none;'
				},
				challengeStartTime: {
					type: Number,
					value: 0
				},
				taskStartTime: {
					type: Number,
					value: 0
				}
			},
			observers: [
				'afterPropertiesSet(challenge, result)'
			],
			listeners: {
				'task-timeout': '_taskTimeout',
				'challenge-timeout': '_challengeTimeout',
				'server-finished-task': '_serverFinishedTask'
			},
			afterPropertiesSet: function() {
				this.contentStyle = '';
				var currentTask = '';
				if(this.result.startTimes){
					for(var i=0; i<this.challenge.tasks.length; i++){
						if(new Date(this.result.startTimes[i]).getTime()>0){
							this.taskIndex = i;
							currentTask = this.challenge.tasks[this.taskIndex];
						}
					}
				}
				if(currentTask.id && this.taskIndex >= 0){
					this.challengeStartTime = new Date(this.result.startTimes[0]).getTime();
					this.taskStartTime = new Date(this.result.startTimes[this.taskIndex]).getTime();

					this.task = currentTask;
					this.$.coolNav.start();
				}else{
					this.startChallenge();
				}
			},
			startChallenge: function() {
				this.task = this.challenge.tasks[this.taskIndex];
				this.startTask(this.task.id);
				// TODO - update result and set starting time
				this.$.coolNav.start();
			},
			startTask: function(taskId){
				this.$.taskService.startTask(localStorage.result, taskId);
			},
			_serverFinishedTask: function(){
				this._nextTask();
			},
			_taskChanged: function(){
				if(!this.task){
					return;
				}
				this.$.coolNav.refreshTaskTimer();
				this.importHref('/elements/coder/challenge/tasks/' + this.task.endpoint.component + '.html', function(){
					var webInterface = document.createElement(this.task.endpoint.component);
					webInterface.task = this.task;

					var element = this;
					webInterface.addEventListener('task-finished', function(){
						var msg = 'Are you sure you want to finish this task? You will not able to come back again and change it.';
						if (!window.confirm(msg)) {
							return;
						}
						// TODO(victorbalan): Do we really need this lastSubmission param?
						// element.$.taskService.finishTask(element.result.Key, element.taskIndex, localStorage.getItem('lastSubmission'));
						element._nextTask();
					});

					this._replaceContent(webInterface);
				});
			},
			_nextTask: function(){
				this.taskStartTime = 0;

				this.taskIndex++;
				if(this.taskIndex < this.challenge.tasks.length){
					this.task = this.challenge.tasks[this.taskIndex];
					this.startTask(this.task.id);
					return;
				}
				this.$.coolNav.stop();
				// This starts the result computing
				this.$.getResultRequest.url = util.build('/results/' + this.result.id);
				this.$.getResultRequest.generateRequest();

				this._importAndReplaceContent('/elements/coder/challenge/info/challenge-finished.html', 'challenge-finished');

				app.finishChallenge();
			},
			_taskTimeout: function(){
				this.taskStartTime = 0;
				this._nextTask();
			},
			_challengeTimeout: function(){
				this._importAndReplaceContent('/elements/coder/challenge/info/challenge-timeout.html', 'challenge-timeout');
			},
			_replaceContent: function(element){
				this.contentStyle = '';
				this.$.content.innerHTML = '';
				this.$.content.appendChild(element);
			},
			_importAndReplaceContent: function(importPath, elementName){
				this.importHref(importPath, function(){
					this._replaceContent(document.createElement(elementName));
				});
			}
		});

	</script>
</dom-module>
