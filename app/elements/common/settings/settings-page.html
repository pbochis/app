<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-form/iron-form.html">

<link rel="import" href="../error/errors-display.html">

<dom-module id="settings-page">
	<style include="iron-flex iron-flex-reverse">
		.list-item {
			@apply(--layout-horizontal);
		}

		.list-item > .item-label{
			width:200px;
			font-weight: bold;
		}

		.aligned-item {
			margin-left: 200px;
		}
		#form {
			@apply(--layout-vertical);
		}
		#buttons {
			@apply(--layout-horizontal-reverse);
		}

		paper-input {
			width: 400px;
		}

		#wrapper {
			margin-left: 20%;
			margin-right: 20%;
			width: 60%;
		}
	</style>
	<template>
		<user-service id="userService" user="{{user}}" error="{{error}}"></user-service>
		<paper-material id="wrapper" elevation="1" class="card">
			<div class="mainContent">
				<errors-display id="errors" error="{{error}}"></errors-display>
				<form is="iron-form" id="form">
					<div>
						<div class="list-item">
							<div class="item-label">Name</div>
							<div>{{fullName}}</div>
						</div>
						<div class="aligned-item">
							<paper-input label="First name" value="{{user.firstName}}"
								pattern="^[\w-\. ]{2,40}$" auto-validate
								error-message="Must be between 2 and 40 chars and only contain letters."></paper-input>
							<paper-input label="Last name" value="{{user.lastName}}"
								pattern="^[\w-\. ]{2,40}$" auto-validate
								error-message="Must be between 2 and 40 chars and only contain letters."></paper-input>
						</div>
					</div>
					<div>
						<div class="list-item">
							<div class="item-label">Username</div>
							<paper-input value="{{user.username}}" no-label-float
								required minlength="5" maxlength="40" auto-validate pattern="^[a-zA-Z0-9]+(-[a-zA-Z0-9]+)*$"
								error-message="Must be between 5 and 40 chars and only contain letters and numbers."></paper-input>
						</div>
						<div class="aligned-item">
							<p>Your public username is the same as your profile address</p>
							<p><a href="https://app.cod.uno/u/[[user.username]]">https://app.cod.uno/u/<span>[[user.username]]</span></a></p>
						</div>
					</div>
					<div>
						<div class="list-item">
							<div class="item-label">Email</div>
							<paper-input value="{{user.email}}" no-label-float type="email"
								required auto-validate error-message="Please enter a valid email 'me@mail.example'"></paper-input>
						</div>
					</div>
					<div>
						<div class="list-item">
							<div class="item-label">Password</div>
							<paper-button class="primary" on-click="_showChangePasswordDialog">Change password</paper-button>
						</div>
					</div>
				</form>
				<div class="aligned-item">
					<paper-button raised on-click="_saveUser" class="success" disabled="{{saveDisabled}}">Save</paper-button>
				</div>
			</div>
		</paper-material>
		<change-password-dialog id="changePasswordDialog"></change-password-dialog>
	</template>
</dom-module>

<script>
	Polymer({
		is: 'settings-page',
		properties: {
			user: {
				type: Object
			},
			fullName: {
				type: String,
				computed: '_getFullName(user.firstName, user.lastName)'
			},
			password: {
				type: Object,
				value: {}
			},
			saveDisabled: {
				type: Boolean,
				value: true
			}
		},
		listeners: {
			'keyup': '_userChanged'
		},
		ready: function(){
			this.$$('user-service').whoAmI();
		},
		_userChanged: function(){
			this.saveDisabled = !this.$.form.validate();
		},
		_saveUser: function(){
			if(!this.$.form.validate()){
				return;
			}
			this.$.userService.updateMe(this.user);
		},
		_showChangePasswordDialog: function(){
			this.$.changePasswordDialog.open();
		},
		_getFullName: function(firstName, lastName){
			var name = '';
			if(firstName){
				name = firstName + ' ';
			}
			if(lastName){
				name = name + lastName;
			}
			return name;
		}
});
</script>
