<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="coduno-iron-ajax">
	<template>
		<iron-ajax
			id="ajaxRequest"
		  	method="{{method}}"
		  	content-type="{{contentType}}"
		  	handle-as="{{handleAs}}"
		  	last-response="{{lastResponse}}"
		  	headers="{{headers}}"
			body="{{body}}"
		  	debounce-duration="{{debounceDuration}}"
			on-response="_onResponse"
			on-error="_onError"
			with-credentials="true">
		</iron-ajax>
	</template>
	<script>
		Polymer({
			is: 'coduno-iron-ajax',
			properties: {
				response: {
					type: Object,
					notify: true,
					reflectToAttribute: true
				},
				error: {
					type: Object,
					notify: true,
					reflectToAttribute: true
				},
				suffix: {
					type: String,
					notify: true
				},
				contentType: {
					type: String,
					notify: true,
					value: 'application/json'
				},
				handleAs:{
					type: String,
					notify: true,
					value: 'json'
				}
			},
			generateRequest: function(){
				console.log(this.suffix);
				this.$.ajaxRequest.url = this._buildUrl();
				this.$.ajaxRequest.generateRequest();
			},
			_onResponse: function(r){
				this.error = null;
				this.response = r.detail.response;
				this.fire('response', r);
			},
			_onError: function(e){
				this.error = {
					'status': e.detail.request.xhr.status,
					'error': e.detail.request.xhr.response
				};
				if (this.error.status === 500 || this.error.status === 404 || this.error.status === 403){
					util.error(this.error);
					return;
				}
				if (this.error.status === 401){
					page('/login');
				}
				this.fire('error', e);
			},
			_buildUrl: function(){
				return util.build(this.suffix);
			}
		});
	</script>
</dom-module>
