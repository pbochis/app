<link rel="import" href="/elements/common/services/user-service.html">

<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-input/all-imports.html">
<link rel="import" href="/bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<dom-module id="register-page">
	<style type="text/css" include="iron-flex">
:host {
	/* layout properties for the host element */
	@apply(--layout-vertical);
}

iron-icon.huge {
	--iron-icon-height: 50%;
	--iron-icon-width: 50%;
}

paper-material {
	width: 70%;
	background-color: white;

	/* four times the width of iron-icon.huge */
	max-width: 576px;

	/* places this in the middle */
	margin: auto;
}

paper-material > div {
	padding: 24px;
}

paper-material > div:first-child {
	height: 15%;
	max-height: 248px;
	padding: 5%;
	background: #373b50;
	color: white;

	@apply(--layout-horizontal);
	@apply(--layout-center);
}

paper-material > div:first-child > div {
	width: 100%;

	@apply(--layout-vertical);
	@apply(--layout-center);
}

paper-material > div > paper-button {
	width: 100%;

	margin: 0 !important;
	margin-top: 12px !important;
}

span {
	@apply(--layout-flex);
}
	</style>
	<template>
		<user-service id="userService" on-response="_onResponse" on-error="_onError"></user-service>
		<paper-material elevation="1">
			<div>
				<div>
					<iron-icon class="huge" icon="account-circle"></iron-icon>
				</div>
			</div>
			<div>
				<form is="iron-form" id="userForm">
					<gold-email-input
						label="Email"
						value="{{user.email}}"
						autofocus="true"
						on-keydown="onKeydown"
						error-message="Please enter a valid email"
						required>
					</gold-email-input>
					<paper-input
						type="text"
						label="Username"
						value="{{user.nick}}"
						autofocus="true"
						minLength="5"
						maxLength="60"
						on-keydown="onKeydown"
						error-message="Username must be between 5 and 60 characters and only contain alphanumerical characters."
						required>
					</paper-input>
					<paper-input
						type="password"
						label="Password"
						value="{{user.password}}"
						autofocus="true"
						on-keydown="onKeydown"
						minLength="6"
						maxLength="40"
						error-message="Password must be between 6 and 40 characters."
						required>
					</paper-input>
					<paper-input type="password" label="Repeat password" value="{{repeatedPassword}}" autofocus="true" on-keydown="onKeydown" required></paper-input>
				</form>
				<paper-button flat colorful on-change="checkEmpty" on-click="register">Register</paper-button>
			</div>
			<div class="horizontal layout">
				<span class="flex"></span>
				<a href="/login">Already have an account? Sign in here.</a>
				<span class="flex"></span>
			</div>
		</paper-material>
		<paper-toast id="toast"></paper-toast>
	</template>
</dom-module>

<script>
Polymer({
	is: 'register-page',
	properties: {
		empty: {
			type: String,
			notify: true
		},
		user: {
			type: Object,
			value: {}
		}
	},
	behaviors: [
		Polymer.NeonAnimatableBehavior
	],
	_onResponse: function(){
		page('/login');
	},
	register: function() {
		if (!this.$.userForm.validate()){
			return;
		}
		if(this.user.password !== this.repeatedPassword){
			this.$.toast.text = 'Passwords do not match';
			this.$.toast.show();
			return;
		}
		this.$.userService.save(this.user);
	},
	onKeydown: function(e) {
		if (e.keyCode === 13) {
			this.register();
		}
	},
	_onError: function(e, err){
		if (err.detail.request.xhr.status === 409){
			this.$.toast.text = 'Username/email already taken';
			this.$.toast.show();
			return;
		}
		util.error(err);
	}
});
</script>
