<script src="../bower_components/page/page.js"></script>
<script>
window.addEventListener('WebComponentsReady', function() {
	function checkIsOrganization() {
		return !!localStorage.organization || page.redirect('/login');
	}
	
	page('/', function() {
		if (!localStorage.authorization){
			page('/login');
		}else if (util.organization()) {
			page('/candidates');
		} else {
			page('/challenge');
		}
	});

	page('/token/:token', function(context) {
		var token = context.params.token;
		var decodedToken = atob(token).split(':');
		localStorage.setItem('authorization', 'Token '+ decodedToken[1]);
		localStorage.setItem('challenge', decodedToken[0]);
		page('/challenge');
	});

	page('/register', function() {
		app.route = 'register';
		Polymer.Base.importHref('/elements/register/register-page.html');
	});

	page('/challenge', function() {
		app.route = 'challenge';
		Polymer.Base.importHref('/elements/submission/challenge-page.html', function(){
			app.startChallenge();
		});
	});

	page('/challenge/create', function() {
		app.route = 'tasks';
		Polymer.Base.importHref('/elements/task/task-list.html', function(){
				app.$.taskList.getTasks();
				app.$.taskList.startChallengeCreation();
			});
	});

	page('/challenges', function () {
		app.route = 'challenges';
		Polymer.Base.importHref('/elements/challenge/challenge-list.html', function(){
			app.$.challengeList.getChallenges();
		});
	});

	page('/challenges/:challengeKey', function(data){
		checkIsOrganization();
		app.route = 'challenge-detail';
		Polymer.Base.importHref('/elements/challenge/challenge-detail.html', function(){
			app.$.challengeDetail.loadData(data.params.challengeKey);
		});
	});

	page('/unauthorized', function() {
		app.route = 'unauthorized';
	});

	page('/coders/:id', function(data) {
		checkIsOrganization();
		app.route = 'coder-info';
		app.params = data.params;
	});

	page('/candidates', function() {
		checkIsOrganization();
		app.route = 'candidate';
		Polymer.Base.importHref('/elements/candidates/candidate-page.html', function(){
			app.$.candidatePage.getChallenges();
			app.$.candidatePage.getCandidates();
		});
	});

	page('/tasks', function() {
		checkIsOrganization();
		app.route = 'tasks';
		Polymer.Base.importHref('/elements/task/task-list.html', function(){
			app.$.taskList.getTasks();
		});
	});

	page('/tasks/:taskKey', function(data) {
		checkIsOrganization();
		app.route = 'task-detail';
		Polymer.Base.importHref('/elements/task/task-detail.html', function() {
			app.$.taskDetail.getTask(data.params.taskKey);
		});
	});

	page('/task/create', function(){
		checkIsOrganization();
		app.route = 'task-create';
		Polymer.Base.importHref('/elements/task/task-form.html');
	});

	page('/user/:userKey', function(context){
		checkIsOrganization();
		app.route = 'user';
		Polymer.Base.importHref('/elements/user/user-detail.html', function(){
			app.$.userDetail.getData(context.params.userKey);
		});
	});

	page('/user/:userKey/challenge/:challengeKey', function(context){
		checkIsOrganization();
		app.route = 'userChallenge';
		Polymer.Base.importHref('/elements/user/challenge/user-challenge-detail.html', function(){
			app.$.userChallengeDetail.getData(context.params.userKey, context.params.challengeKey);
		});
	});

	page('/login', function(ctx) {
		app.route = 'login';
		Polymer.Base.importHref('/elements/login/login-wizard/login-wizard.html', function(){
			if(!ctx.querystring){
				return;
			}
			var qs = ctx.querystring.split('&');
			for(var i=0;i<qs.length;i++) {
				if(qs[i].indexOf('address=')===0) {
					app.$.loginWizard.setEmail(qs[i].split('=')[1]);
					return;
				}
			}
		});
	});

	page('/logout', function() {
		app.logout();
	});

	page('/error', function() {
		app.$.error.initialError = util.initialError;
		app.route = 'error';
	});

	page({
		hashbang: true
	});
});
</script>
