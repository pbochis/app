<script src="../bower_components/page/page.js"></script>
<script>
window.addEventListener('WebComponentsReady', function() {
	function checkIsOrganization() {
		return !!util.organization() || page.redirect('/login');
	}

	page('/', function() {
		if (util.organization()) {
			page('/challenges');
		} else if(util.user()){
			page('/challenge');
		} else {
				page('/login');
		}
	});

	page('/token/:token', function(context) {
		var token = context.params.token;
		app.inviteByToken(token);
	});

	page('/register', function() {
		app.route = 'register';
		Polymer.Base.importHref('/elements/common/register/register-page.html');
	});

	page('/challenge/:id', function(context) {
		app.route = 'challenge';
		app.challenge = context.params.id;
		Polymer.Base.importHref('/elements/coder/challenge/page/challenge-page.html');
	});

	page('/challenge/template/:templateId/create', function(data) {
		app.route = 'challenge-create';
		Polymer.Base.importHref('/elements/company/challenge/challenge-create.html', function(){
			app.$.challengeCreate.challengeTemplate = data.params.templateId;
		});
	});

	page('/challenge/create', function() {
		app.route = 'tasks';
		Polymer.Base.importHref('/elements/company/task/task-list.html', function(){
				app.$.taskList.getTasks();
				app.$.taskList.startChallengeCreation();
			});
	});

	page('/challenges', function () {
		app.route = 'challenges';
		Polymer.Base.importHref('/elements/company/challenge/template/challenge-template-list.html', function(){
			app.$.challengeList.getChallenges();
		});
	});

	page('/challenges/:challengeKey', function(data){
		checkIsOrganization();
		app.route = 'challenge-detail';
		Polymer.Base.importHref('/elements/company/challenge/template/challenge-template-detail.html', function(){
			app.$.challengeTemplateDetail.loadData(data.params.challengeKey);
		});
	});

	page('/unauthorized', function() {
		app.route = 'unauthorized';
	});

	page('/coders/:id', function(data) {
		checkIsOrganization();
		app.route = 'coder-info';
		app.params = data.params;
	});

	page('/tasks', function() {
		checkIsOrganization();
		app.route = 'tasks';
		Polymer.Base.importHref('/elements/company/task/task-list.html', function(){
			app.$.taskList.getTasks();
		});
	});

	page('/tasks/:id', function(data) {
		checkIsOrganization();
		app.route = 'task-detail';
		Polymer.Base.importHref('/elements/company/task/task-detail.html', function() {
			app.$.taskDetail.getTask(data.params.id);
		});
	});

	page('/task/create', function(){
		checkIsOrganization();
		app.route = 'task-create';
		Polymer.Base.importHref('/elements/company/task/task-form.html');
	});

	page('/task/edit/:id', function(context){
		checkIsOrganization();
		app.route = 'task-edit';
		app.$.taskEditForm.taskId = context.params.id;
		Polymer.Base.importHref('/elements/company/task/task-form.html');
	});

	page('/user/:userKey', function(context){
		checkIsOrganization();
		app.route = 'user';
		Polymer.Base.importHref('/elements/company/user/user-detail.html', function(){
			app.$.userDetail.getData(context.params.userKey);
		});
	});

	page('/user/:userKey/challenge/:challengeKey', function(context){
		checkIsOrganization();
		app.route = 'userChallenge';
		Polymer.Base.importHref('/elements/company/user/challenge/user-challenge-detail.html', function(){
			app.$.userChallengeDetail.getData(context.params.userKey, context.params.challengeKey);
		});
	});

	page('/login', function(ctx) {
		app.route = 'login';
		app.isLoggedIn = false;
		Polymer.Base.importHref('/elements/common/login/login-wizard/login-wizard.html', function(){
			if(!ctx.querystring){
				return;
			}
			var qs = ctx.querystring.split('&');
			for(var i=0;i<qs.length;i++) {
				if(qs[i].indexOf('address=')===0) {
					app.$.loginWizard.setEmail(qs[i].split('=')[1]);
					return;
				}
			}
		});
	});

	page('/logout', function() {
		app.logout();
	});

	page('/error', function() {
		app.$.error.initialError = util.initialError;
		app.route = 'error';
	});

	page({
		hashbang: true
	});
});
</script>
